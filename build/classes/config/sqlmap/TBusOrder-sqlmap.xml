<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="busOrder">
	<resultMap class="com.hansy.transaction.model.vo.TBusOrderVo" id="busOrderVoResultMap">
		<result property="orderNo" column="ORDER_NO"/>
		<result property="orderType" column="ORDER_TYPE"/>
		<result property="splitStatus" column="SPLIT_STATUS"/>
		<result property="custNo" column="CUST_NO"/>
		<result property="goodsNo" column="GOODS_NO"/>
		<result property="goodsPrice" column="GOODS_PRICE"/>
		<result property="goodsDiscount" column="GOODS_DISCOUNT"/>		
		<result property="defaultPayDt" column="DEFAULT_PAY_DT"/>	
		<result property="wishPayDt" column="WISH_PAY_DT"/>
		<result property="orderStatus" column="ORDER_STATUS"/>
		<result property="insertDate" column="INSERT_DATE"/>
		<result property="updateDate" column="UPDATE_DATE"/>
		<result property="supplyNo" column="SUPPLY_NO"/>
		<result property="goodsCount" column="GOODS_COUNT"/>
		<result property="address" column="ADDRESS"/>
		<result property="status" column="STATUS"/>
		<result property="tableKey" column="TABLE_KEY"/>
		<result property="orderStatusSel" column="ORDER_STATUS_SEL"/>
		<result property="upOrderNo" column="UP_ORDER_NO"/>
		<result property="updateCustType" column="UPDATE_CUST_TYPE"/>
		<result property="goodsMoney" column="GOODS_MONEY"/>
		<result property="lgtNums"  column="LGT_NUMS"/>
	</resultMap>
	
	<sql id="allColumns">
		ORDER_STATUS_SEL,TABLE_KEY,ORDER_NO,ORDER_TYPE,SPLIT_STATUS,CUST_NO,GOODS_NO,GOODS_PRICE,GOODS_DISCOUNT,DEFAULT_PAY_DT,WISH_PAY_DT,ORDER_STATUS,INSERT_DATE,UPDATE_DATE,SUPPLY_NO,GOODS_COUNT,ADDRESS,STATUS,UP_ORDER_NO,UPDATE_CUST_TYPE,GOODS_MONEY
	</sql>
	
	
	<select id = "productRank" parameterClass="map" resultClass="com.hansy.transaction.model.vo.GoodAlls">
	SELECT t1.TOTAL_AMT totala ,
  t1.totalNum totalNum,
  NVL(t2.guige
  ||''
  || t2.product_property,'') guigee,
  p.name
  ||SUBSTR(t2.c1,1,INSTR(t2.c1,',',1,3)-1) goodsName
FROM
  (SELECT SUM(GOODS_MONEY) TOTAL_AMT,
    SUM(GOODS_COUNT) totalNum,
    goods_no gg
  FROM T_BUS_ORDER T
  WHERE 1            =1
  <dynamic prepend="">	
  <isNotEmpty property="orderStatus" prepend="and">
   						  <![CDATA[ 
		                   T.ORDER_STATUS= #orderStatus#
		                ]]>
			</isNotEmpty>
  
		<isNotEmpty property="startTime" prepend="and">
   						  <![CDATA[ 
		                   AND t.UPDATE_DATE >= to_date(#startTime#, 'yy-mm-dd')
		                ]]>
			</isNotEmpty>
			<isNotEmpty property="endTime" prepend="and">
					    <![CDATA[
					        AND t.UPDATE_DATE < to_date(#endTime#, 'yy-mm-dd')
					    ]]>
			</isNotEmpty>				         
		</dynamic>
  GROUP BY goods_no
  )t1
LEFT JOIN DATA_CP t2
ON t2.id = t1.gg
LEFT JOIN data_cpmls p
ON p.code = t2.code
where 1=1
	  <dynamic prepend="">	
 <isNotEmpty property="query" prepend="and">  
				                <![CDATA[ 
				                    (t2.guigee like '%$query$%' or t2.goodsName like '%$query$%')
				                ]]>  
				            </isNotEmpty> 
				            
				            <isNotEmpty property="Sort1">
				<isEqual property="Sort1" compareValue="0">
						order by t1.totalNumL desc
				</isEqual>
				<isEqual property="Sort1" compareValue="1">
						order by t1.totalNum asc
				</isEqual>
			</isNotEmpty>
			<isNotEmpty property="Sort2">
				<isEqual property="Sort2" compareValue="0">
						order by t1.totala desc
				</isEqual>

				<isEqual property="Sort2" compareValue="1">
						order by t1.totala asc
				</isEqual>
			</isNotEmpty>
		</dynamic>
	</select>
	
	
	<select id="selectSupplyOrdersCountpage" parameterClass="java.util.HashMap" resultClass="com.hansy.transaction.model.bo.Order">
		select distinct TEMP.ORDER_NO orderNo from
		 (SELECT ORDER_NO,
                 ORDER_TYPE,
                 SPLIT_STATUS,
                 CUST_NO,
                 GOODS_NO,
                 GOODS_PRICE,
                 GOODS_DISCOUNT,
                 DEFAULT_PAY_DT,
                 WISH_PAY_DT,
                 ORDER_STATUS,
                 INSERT_DATE,
                 UPDATE_DATE,
                 SUPPLY_NO,
                 GOODS_COUNT,
                 ADDRESS,
                 STATUS,
                 goods_money,
                 UPDATE_CUST_TYPE,
                 TABLE_KEY,
                 ORDER_STATUS_SEL,
                 LGT_NUMS
            FROM T_BUS_ORDER TEMP
           WHERE ORDER_STATUS_SEL = '1'
             AND SPLIT_STATUS in ('0','2') ) TEMP 
    LEFT JOIN DATA_CP CP
      ON TEMP.GOODS_NO = CP.CPDM
    LEFT JOIN DATA_CPMLS MLS
      ON CP.CODE = MLS.CODE
    LEFT JOIN T_USER_BASE_INFO U
      ON TEMP.CUST_NO = U.CUST_NO
     LEFT JOIN T_BUS_ADDRESS D
      ON TEMP.ORDER_NO = D.ORDER_NO
       left join T_USER_BASE_INFO SP
      ON TEMP.SUPPLY_NO = SP.CUST_NO
      where 1=1
		            <isNotEmpty property="orderStatus" prepend="and">  
		                <![CDATA[ 
		                    temp.order_status = #orderStatus# 
		                ]]>  
		            </isNotEmpty>
		             <isNotEmpty property="custNo" prepend="and">  
		                <![CDATA[ 
		                    temp.supply_no = #custNo# 
		                ]]>  
		            </isNotEmpty>   
		            <isNotEmpty prepend="and" property="queryWay">
     				 	<![CDATA[
     				 	  (  u.user_phone like '%$queryWay$%' or mls.name like '%$queryWay$%' or u.cust_name like '%$queryWay$%' or TEMP.ORDER_NO = #queryWay# )
     				 	   ]]>
     				 </isNotEmpty>
     			order by temp.ORDER_NO desc
	</select>
	<select id="selectSupplyOrders1" parameterClass="java.util.HashMap" resultClass="com.hansy.transaction.model.bo.Order">
		  SELECT TEMP.ORDER_STATUS ORDERSTATUS,
         TEMP.ORDER_NO ORDERNO,
         TEMP.GOODS_PRICE GOODSPRICE,
         TEMP.GOODS_COUNT GOODSCOUNT,
         TEMP.GOODS_DISCOUNT GOODSDISCOUNT,
         TEMP.INSERT_DATE INSERTDATE,
         TEMP.ORDER_TYPE ORDERTYPE,
         TEMP.TABLE_KEY TABLEKEY,
         TEMP.SPLIT_STATUS splitStatus,
         TEMP.goods_money goodsMoney,
         TEMP.LGT_NUMS LGTNUMS,
         U.CUST_NAME CUSTNAME,
         U.USER_PHONE CUSTPHONE,
         U.CUST_NO CUSTNO,
           SP.cust_name supperName,
       SP.user_phone supperPhone,
       TEMP.SUPPLY_NO supplyNo,
         MLS.NAME GOODSNAME,
         MLS.CODE GOODSCODE,
         TO_CHAR(TEMP.INSERT_DATE + TEMP.DEFAULT_PAY_DT, 'yyyy-mm-dd') DEFAULTPAYDT,
         TO_CHAR(TEMP.INSERT_DATE + TEMP.WISH_PAY_DT, 'yyyy-mm-dd') WISHPAYDT,
         D.TELEPHONE ADDRESSEEPHONE,
         D.ADDRESSEE_NAME ADDRESSEENAME,
         D.ADDRESS ADDRESS,
         SUBSTR(CP.C1, 1, decode(INSTR(CP.C1, ',', 1, 3 ),0,LENGTH(CP.C1) ,INSTR(CP.C1, ',', 1, 3 )) - 1) PAR,
         TEMP.GOODS_NO GOODSNO
    FROM (SELECT ORDER_NO,
                 ORDER_TYPE,
                 SPLIT_STATUS,
                 CUST_NO,
                 GOODS_NO,
                 GOODS_PRICE,
                 GOODS_DISCOUNT,
                 DEFAULT_PAY_DT,
                 WISH_PAY_DT,
                 ORDER_STATUS,
                 INSERT_DATE,
                 UPDATE_DATE,
                 SUPPLY_NO,
                 GOODS_COUNT,
                 ADDRESS,
                 STATUS,
                 UPDATE_CUST_TYPE,
                 TABLE_KEY,
                 goods_money,
                 ORDER_STATUS_SEL,
                 LGT_NUMS
            FROM T_BUS_ORDER TEMP
           WHERE ORDER_STATUS_SEL = '1'
            AND SPLIT_STATUS in ('0','2')) TEMP 
    LEFT JOIN DATA_CP CP
      ON TEMP.GOODS_NO = CP.CPDM
    LEFT JOIN DATA_CPMLS MLS
      ON CP.CODE = MLS.CODE
    LEFT JOIN T_USER_BASE_INFO U
      ON TEMP.CUST_NO = U.CUST_NO
    LEFT JOIN T_BUS_ADDRESS D
      ON TEMP.ORDER_NO = D.ORDER_NO
       left join T_USER_BASE_INFO SP
      ON TEMP.SUPPLY_NO = SP.CUST_NO
     
    where 1=1
    		<dynamic prepend="">  
		            <isNotEmpty property="orderStatus" prepend="and">  
		                <![CDATA[ 
		                    temp.order_status = #orderStatus# 
		                ]]>  
		            </isNotEmpty>
		             <isNotEmpty property="custNo" prepend="and">  
		                <![CDATA[ 
		                    temp.supply_no = #custNo# 
		                ]]>  
		            </isNotEmpty> 
		             
		            <isNotEmpty prepend="and" property="queryWay">
     				 	<![CDATA[
     				 	  (  u.user_phone like '%$queryWay$%' or mls.name like '%$queryWay$%' or u.cust_name like '%$queryWay$%' or TEMP.ORDER_NO = #queryWay# )
     				 	   ]]>
     				 </isNotEmpty>
		        </dynamic>	 
		         <dynamic prepend=" and ">  
        <isNotNull property="orderNoList">  
             TEMP.ORDER_NO in  
            <iterate property="orderNoList" open="(" conjunction="," close=")">  
                #orderNoList[].orderNo#  
                    </iterate>                      
        </isNotNull>  
    </dynamic>   
           			 order by temp.UPDATE_DATE desc
	</select>
	
	
	
	<!-- 获取供方订单分页list -->
	
	<!-- 获取供方订单分页总条数 -->
	<select id="selectSupplyOrdersCount" parameterClass="java.util.HashMap" resultClass="java.lang.Integer">
		select count(distinct TEMP.ORDER_NO)from
		 (SELECT ORDER_NO,
                 ORDER_TYPE,
                 SPLIT_STATUS,
                 CUST_NO,
                 GOODS_NO,
                 GOODS_PRICE,
                 GOODS_DISCOUNT,
                 DEFAULT_PAY_DT,
                 WISH_PAY_DT,
                 ORDER_STATUS,
                 INSERT_DATE,
                 UPDATE_DATE,
                 SUPPLY_NO,
                 GOODS_COUNT,
                 ADDRESS,
                 STATUS,
                 goods_money,
                 UPDATE_CUST_TYPE,
                 TABLE_KEY,
                 ORDER_STATUS_SEL
            FROM T_BUS_ORDER TEMP
           WHERE ORDER_STATUS_SEL = '1'
             AND SPLIT_STATUS in ('0','2') ) TEMP 
    LEFT JOIN DATA_CP CP
      ON TEMP.GOODS_NO = CP.CPDM
    LEFT JOIN DATA_CPMLS MLS
      ON CP.CODE = MLS.CODE
    LEFT JOIN T_USER_BASE_INFO U
      ON TEMP.CUST_NO = U.CUST_NO
     LEFT JOIN T_BUS_ADDRESS D
      ON TEMP.ORDER_NO = D.ORDER_NO
       left join T_USER_BASE_INFO SP
      ON TEMP.SUPPLY_NO = SP.CUST_NO
      where 1=1
		            <isNotEmpty property="orderStatus" prepend="and">  
		                <![CDATA[ 
		                    temp.order_status = #orderStatus# 
		                ]]>  
		            </isNotEmpty>
		             <isNotEmpty property="custNo" prepend="and">  
		                <![CDATA[ 
		                    temp.supply_no = #custNo# 
		                ]]>  
		            </isNotEmpty>   
		            <isNotEmpty prepend="and" property="queryWay">
     				 	<![CDATA[
     				 	  (  u.user_phone like '%$queryWay$%' or mls.name like '%$queryWay$%' or u.cust_name like '%$queryWay$%' or TEMP.ORDER_NO = #queryWay# )
     				 	   ]]>
     				 </isNotEmpty>
	</select>
	<!-- 获取买方订单分页list -->
	<select id="selectBuyerOrders1" parameterClass="java.util.HashMap" resultClass="com.hansy.transaction.model.bo.Order">
		SELECT TEMP.ORDER_STATUS ORDERSTATUS,
         TEMP.ORDER_NO ORDERNO,
         TEMP.GOODS_PRICE GOODSPRICE,
         TEMP.GOODS_COUNT GOODSCOUNT,
         TEMP.GOODS_DISCOUNT GOODSDISCOUNT,
         TEMP.INSERT_DATE INSERTDATE,
         TEMP.ORDER_TYPE ORDERTYPE,
         TEMP.TABLE_KEY TABLEKEY,
         TEMP.SPLIT_STATUS splitStatus,
         TEMP.goods_money goodsMoney,
         TEMP.LGT_NUMS LGTNUMS,
        u.cust_name applyName,
       u.user_phone applyPhone,
       u.cust_no custNo,
         cp.brand brand,
         cp.code code,
       SP.cust_name supperName,
       SP.user_phone supperPhone,
       TEMP.SUPPLY_NO supplyNo,
         MLS.NAME GOODSNAME,
         MLS.CODE GOODSCODE,
         TO_CHAR(TEMP.INSERT_DATE + TEMP.DEFAULT_PAY_DT, 'yyyy-mm-dd') DEFAULTPAYDT,
         TO_CHAR(TEMP.INSERT_DATE + TEMP.WISH_PAY_DT, 'yyyy-mm-dd') WISHPAYDT,
         D.TELEPHONE ADDRESSEEPHONE,
         D.ADDRESSEE_NAME ADDRESSEENAME,
         D.ADDRESS ADDRESS,
         SUBSTR(CP.C1, 1, decode(INSTR(CP.C1, ',', 1, 3 ),0,LENGTH(CP.C1) ,INSTR(CP.C1, ',', 1, 3 )) - 1) PAR,
         TEMP.GOODS_NO GOODSNO
    FROM (SELECT ORDER_NO,
                 ORDER_TYPE,
                 SPLIT_STATUS,
                 CUST_NO,
                 GOODS_NO,
                 GOODS_PRICE,
                 GOODS_DISCOUNT,
                 DEFAULT_PAY_DT,
                 WISH_PAY_DT,
                 ORDER_STATUS,
                 INSERT_DATE,
                 UPDATE_DATE,
                 SUPPLY_NO,
                 GOODS_COUNT,
                 ADDRESS,
                 STATUS,
                 UPDATE_CUST_TYPE,
                 TABLE_KEY,
                 goods_money,
                 LGT_NUMS,
                 ORDER_STATUS_SEL
            FROM T_BUS_ORDER TEMP
           WHERE STATUS = '1'
             AND SPLIT_STATUS in ('0','2')
           ) TEMP 
    LEFT JOIN DATA_CP CP
      ON TEMP.GOODS_NO = CP.CPDM
    LEFT JOIN DATA_CPMLS MLS
      ON CP.CODE = MLS.CODE
    LEFT JOIN T_USER_BASE_INFO U
      ON TEMP.CUST_NO = U.CUST_NO
   LEFT JOIN T_BUS_ADDRESS D
      ON TEMP.ORDER_NO = D.ORDER_NO
      left join T_USER_BASE_INFO SP
      ON TEMP.SUPPLY_NO = SP.CUST_NO
    where 1=1
    		<dynamic prepend="">  
		            <isNotEmpty property="orderStatus" prepend="and">  
		                <![CDATA[ 
		                    temp.order_status = #orderStatus# 
		                ]]>  
		            </isNotEmpty>
		             <isNotEmpty property="custNo" prepend="and">  
		                <![CDATA[ 
		                    temp.cust_no = #custNo# 
		                ]]>  
		            </isNotEmpty>  
		            <isNotEmpty prepend="and" property="queryWay">
     				 	<![CDATA[
     				 	  (  u.user_phone like '%$queryWay$%' or mls.name like '%$queryWay$%' or u.cust_name like '%$queryWay$%' or TEMP.ORDER_NO = #queryWay#  )
     				 	   ]]>
     				 </isNotEmpty>
		        </dynamic>	  
		          <dynamic prepend=" and ">  
        <isNotNull property="orderNoList">  
             TEMP.ORDER_NO in  
            <iterate property="orderNoList" open="(" conjunction="," close=")">  
                #orderNoList[].orderNo#  
                    </iterate>                      
        </isNotNull>  
    </dynamic>  
           			 order by temp.UPDATE_DATE desc
	</select>
	
	<!-- 操作物流号 -->
	<update id="updateLgt" parameterClass="com.hansy.transaction.model.vo.TBusOrderVo">
		update t_bus_order set LGT_NUMS=#lgtNums# where ORDER_NO=#orderNo#
	</update>
	
	<!-- 获取买方订单分页总条数 -->
	<select id="selectBuyerOrdersCount" parameterClass="java.util.HashMap" resultClass="java.lang.Integer">
		select count(distinct TEMP.ORDER_NO)from
		 (SELECT ORDER_NO,
                 ORDER_TYPE,
                 SPLIT_STATUS,
                 CUST_NO,
                 GOODS_NO,
                 GOODS_PRICE,
                 GOODS_DISCOUNT,
                 DEFAULT_PAY_DT,
                 WISH_PAY_DT,
                 ORDER_STATUS,
                 INSERT_DATE,
                 UPDATE_DATE,
                 SUPPLY_NO,
                 GOODS_COUNT,
                 ADDRESS,
                 STATUS,
                 UPDATE_CUST_TYPE,
                 TABLE_KEY,
                 goods_money,
                 ORDER_STATUS_SEL
            FROM T_BUS_ORDER TEMP
           WHERE STATUS = '1'
             AND SPLIT_STATUS in ('0','2')
           ) TEMP 
    LEFT JOIN DATA_CP CP
      ON TEMP.GOODS_NO = CP.CPDM
    LEFT JOIN DATA_CPMLS MLS
      ON CP.CODE = MLS.CODE
    LEFT JOIN T_USER_BASE_INFO U
      ON TEMP.CUST_NO = U.CUST_NO
     LEFT JOIN T_BUS_ADDRESS D
      ON TEMP.ORDER_NO = D.ORDER_NO
       left join T_USER_BASE_INFO SP
      ON TEMP.SUPPLY_NO = SP.CUST_NO
      where 1=1
		            <isNotEmpty property="orderStatus" prepend="and">  
		                <![CDATA[ 
		                    temp.order_status = #orderStatus# 
		                ]]>  
		            </isNotEmpty>
		             <isNotEmpty property="custNo" prepend="and">  
		                <![CDATA[ 
		                    temp.cust_no = #custNo# 
		                ]]>  
		            </isNotEmpty>   
		            <isNotEmpty prepend="and" property="queryWay">
     				 	<![CDATA[
     				 	  (  u.user_phone like '%$queryWay$%' or mls.name like '%$queryWay$%' or u.cust_name like '%$queryWay$%' or TEMP.ORDER_NO = #queryWay# )
     				 	   ]]>
     				 </isNotEmpty>
	</select>
	
	<!-- 获取买方未开发票的订单总条数 -->
	<select id="selectBuyerOrdersCountInvoic" parameterClass="java.util.HashMap" resultClass="java.lang.Integer">
		select count(distinct TEMP.ORDER_NO)from
		 (SELECT ORDER_NO,
                 ORDER_TYPE,
                 SPLIT_STATUS,
                 CUST_NO,
                 GOODS_NO,
                 GOODS_PRICE,
                 GOODS_DISCOUNT,
                 DEFAULT_PAY_DT,
                 WISH_PAY_DT,
                 ORDER_STATUS,
                 INSERT_DATE,
                 UPDATE_DATE,
                 SUPPLY_NO,
                 GOODS_COUNT,
                 ADDRESS,
                 STATUS,
                 UPDATE_CUST_TYPE,
                 TABLE_KEY,
                 goods_money,
                 ORDER_STATUS_SEL
            FROM T_BUS_ORDER TEMP
           WHERE STATUS = '1'
             AND SPLIT_STATUS in ('0','2')
           ) TEMP 
    LEFT JOIN DATA_CP CP
      ON TEMP.GOODS_NO = CP.CPDM
    LEFT JOIN DATA_CPMLS MLS
      ON CP.CODE = MLS.CODE
    LEFT JOIN T_USER_BASE_INFO U
      ON TEMP.CUST_NO = U.CUST_NO
     LEFT JOIN T_BUS_ADDRESS D
      ON TEMP.ORDER_NO = D.ORDER_NO
       left join T_USER_BASE_INFO SP
      ON TEMP.SUPPLY_NO = SP.CUST_NO
      where 1=1
		            <isNotEmpty property="orderStatus" prepend="and">  
		                <![CDATA[ 
		                    temp.order_status = #orderStatus# 
		                ]]>  
		            </isNotEmpty>
		             <isNotEmpty property="custNo" prepend="and">  
		                <![CDATA[ 
		                    temp.cust_no = #custNo# 
		                ]]>  
		            </isNotEmpty>   
		            <isNotEmpty prepend="and" property="queryWay">
     				 	<![CDATA[
     				 	  (  u.user_phone like '%$queryWay$%' or mls.name like '%$queryWay$%' or u.cust_name like '%$queryWay$%' or TEMP.ORDER_NO = #queryWay# )
     				 	   ]]>
     				 </isNotEmpty>
	</select>
	
	
	<select id="selectBuyerPageOrders" parameterClass="java.util.HashMap" resultClass="com.hansy.transaction.model.bo.Order">
		select distinct TEMP.ORDER_NO orderNo from
		 (SELECT ORDER_NO,
                 ORDER_TYPE,
                 SPLIT_STATUS,
                 CUST_NO,
                 GOODS_NO,
                 GOODS_PRICE,
                 GOODS_DISCOUNT,
                 DEFAULT_PAY_DT,
                 WISH_PAY_DT,
                 ORDER_STATUS,
                 INSERT_DATE,
                 UPDATE_DATE,
                 SUPPLY_NO,
                 GOODS_COUNT,
                 ADDRESS,
                 STATUS,
                 UPDATE_CUST_TYPE,
                 TABLE_KEY,
                 goods_money,
                 ORDER_STATUS_SEL
            FROM T_BUS_ORDER TEMP
           WHERE STATUS = '1'
             AND SPLIT_STATUS in ('0','2')
           ) TEMP 
    LEFT JOIN DATA_CP CP
      ON TEMP.GOODS_NO = CP.CPDM
    LEFT JOIN DATA_CPMLS MLS
      ON CP.CODE = MLS.CODE
    LEFT JOIN T_USER_BASE_INFO U
      ON TEMP.CUST_NO = U.CUST_NO
     LEFT JOIN T_BUS_ADDRESS D
      ON TEMP.ORDER_NO = D.ORDER_NO
       left join T_USER_BASE_INFO SP
      ON TEMP.SUPPLY_NO = SP.CUST_NO
      where 1=1
		            <isNotEmpty property="orderStatus" prepend="and">  
		                <![CDATA[ 
		                    temp.order_status = #orderStatus# 
		                ]]>  
		            </isNotEmpty>
		             <isNotEmpty property="custNo" prepend="and">  
		                <![CDATA[ 
		                    temp.cust_no = #custNo# 
		                ]]>  
		            </isNotEmpty>   
		            <isNotEmpty prepend="and" property="queryWay">
     				 	<![CDATA[
     				 	  (  u.user_phone like '%$queryWay$%' or mls.name like '%$queryWay$%' or u.cust_name like '%$queryWay$%' or TEMP.ORDER_NO = #queryWay# )
     				 	   ]]>
     				 </isNotEmpty>
     			 order by temp.ORDER_NO desc
	</select>
	
	
	<!-- 逻辑删除 -->
	<update id="updateStatus" parameterClass="java.util.HashMap">
		update t_bus_order t set t.status='0',t.update_cust_type=#custType#,t.update_date=#nowTime# where t.order_no=#orderNo#
	</update>
	
	<!-- 卖家逻辑删除 -->
	<update id="updateStatusSell" parameterClass="java.util.HashMap">
		update t_bus_order t set t.order_status_sel='0',t.update_cust_type=#custType#,t.update_date=#nowTime# where t.order_no=#orderNo#
	</update>
	
	<!-- 批量新增 -->
	<insert id="saveOrder" parameterClass="java.util.List">
        insert all 
         <iterate conjunction=" ">
         	into t_bus_order(<include refid="allColumns"/>) values 
	           		  (#orderList[].orderStatusSel#,
	           		  #orderList[].tableKey#,
	           		  #orderList[].orderNo#,  
	             	  #orderList[].orderType#,  
	                  #orderList[].splitStatus#,  
	                  #orderList[].custNo#,  
	                  #orderList[].goodsNo#,  
	                  #orderList[].goodsPrice#,  
	                  #orderList[].goodsDiscount#,  
	                  #orderList[].defaultPayDt#,  
	                  #orderList[].wishPayDt#,  
	                  #orderList[].orderStatus#,  
	                  #orderList[].insertDate#,  
	                  #orderList[].updateDate#,  
	                  #orderList[].supplyNo#,  
	                  #orderList[].goodsCount#,  
	                  #orderList[].address#,  
	                  #orderList[].status#,
	                   #orderList[].upOrderNo#,
	                   #orderList[].updateCustType#,
	                   #orderList[].goodsMoney#
	                  ) 
	      </iterate > 
	       select * from dual 
	       <iterate conjunction="">
	       		
	       </iterate>
	</insert>
	<!-- 根据tableKey获取需要修改的订单 -->
	<select id = "getByTableKey" parameterClass="java.lang.String" resultMap="busOrderVoResultMap">
		select t.* from t_bus_order t where t.TABLE_KEY = #tableKey#
	</select>
	<!-- 根据id获取订单 -->
	<select id="getById" parameterClass="java.lang.String" resultMap="busOrderVoResultMap"> 
		select t.* from t_bus_order t where t.order_no=#orderNo#
	</select>
	<select id="getByGoodNo" parameterClass="java.lang.String" resultMap="busOrderVoResultMap"> 
		select t.* from t_bus_order t where t.TABLE_KEY=#tablekey#
	</select>
	<update id="updateOrderStatus" parameterClass="java.util.HashMap">
		update t_bus_order t set t.order_status=#orderStatus#,t.update_date=#nowTime#,t.update_cust_type=#custType#  where t.order_no=#orderNo#
	</update>
	<update id="updateOrderSpiltStatus" parameterClass="java.util.HashMap">
		update t_bus_order t set t.SPLIT_STATUS=#splitStatus# where t.order_no=#orderNo# and t.SPLIT_STATUS =#splitStatus1#
	</update>
	<!-- 修改价格及折扣 -->
	<update id="updateOrderPrice" parameterClass="java.util.HashMap">
		update t_bus_order t set t.goods_Discount=#goodsDiscount#,t.goods_money=#goodsMoney#,t.update_date=#nowTime# where t.TABLE_KEY=#tableKey#
	</update>
	<!-- 插入订单历史纪录表 -->
	<insert id="saveOrderHis" parameterClass="com.hansy.transaction.model.vo.TBusOrderVo">
        insert into t_bus_order_his(TABLE_KEY,ORDER_NO,ORDER_TYPE,SPLIT_STATUS,CUST_NO,GOODS_NO,GOODS_PRICE,GOODS_DISCOUNT,
        DEFAULT_PAY_DT,WISH_PAY_DT,ORDER_STATUS,INSERT_DATE,UPDATE_DATE,SUPPLY_NO,GOODS_COUNT,ADDRESS,STATUS) values 
	           		  (#tableKey#,
	           		  #orderNo#,  
	             	  #orderType#,  
	                  #splitStatus#,  
	                  #custNo#,  
	                  #goodsNo#,  
	                  #goodsPrice#,  
	                  #goodsDiscount#,  
	                  #defaultPayDt#,  
	                  #wishPayDt#,  
	                  #orderStatus#,  
	                  #insertDate#,  
	                  #updateDate#,  
	                  #supplyNo#,  
	                  #goodsCount#,  
	                  #address#,  
	                  #status#) 
	</insert>
	<!-- 插入订单历史纪录表 -->
	<insert id="saveOrderHis1" parameterClass="com.hansy.transaction.model.vo.TBusOrderSplitVo">
        insert into t_bus_order_his(TABLE_KEY,ORDER_NO,ORDER_TYPE,SPLIT_STATUS,CUST_NO,GOODS_NO,GOODS_PRICE,GOODS_DISCOUNT,
        DEFAULT_PAY_DT,WISH_PAY_DT,ORDER_STATUS,INSERT_DATE,UPDATE_DATE,SUPPLY_NO,GOODS_COUNT,ADDRESS,STATUS) values 
	           		  (#tableKey#,
	           		  #orderNo#,  
	             	  #orderType#,  
	                  #splitStatus#,  
	                  #custNo#,  
	                  #goodsNo#,  
	                  #goodsPrice#,  
	                  #goodsDiscount#,  
	                  #defaultPayDt#,  
	                  #wishPayDt#,  
	                  #orderStatus#,  
	                  #insertDate#,  
	                  #updateDate#,  
	                  #supplyNo#,  
	                  #goodsCount#,  
	                  #address#,  
	                  #status#) 
	</insert>
	<!-- 再次购买获得原订单分页信息 -->
	<select id="selectBuyerOldOrders" parameterClass="java.util.HashMap" resultClass="com.hansy.transaction.model.bo.Order">
		SELECT TEMP.ORDER_STATUS ORDERSTATUS,
         TEMP.ORDER_NO ORDERNO,
         TEMP.GOODS_PRICE GOODSPRICE,
         TEMP.GOODS_COUNT GOODSCOUNT,
         TEMP.GOODS_DISCOUNT GOODSDISCOUNT,
         TEMP.INSERT_DATE INSERTDATE,
         TEMP.ORDER_TYPE ORDERTYPE,
         TEMP.TABLE_KEY TABLEKEY,
         TEMP.SPLIT_STATUS splitStatus,
          TEMP.goods_money goodsMoney,
        u.cust_name applyName,
       u.user_phone applyPhone,
       u.cust_no custNo,
       cp.brand,
       SP.cust_name supperName,
       SP.user_phone supperPhone,
       TEMP.SUPPLY_NO supplyNo,
         MLS.NAME GOODSNAME,
         MLS.CODE GOODSCODE,
         TO_CHAR(TEMP.INSERT_DATE + TEMP.DEFAULT_PAY_DT, 'yyyy-mm-dd') DEFAULTPAYDT,
         TO_CHAR(TEMP.INSERT_DATE + TEMP.WISH_PAY_DT, 'yyyy-mm-dd') WISHPAYDT,
         D.TELEPHONE ADDRESSEEPHONE,
         D.ADDRESSEE_NAME ADDRESSEENAME,
         D.ADDRESS ADDRESS,
         SUBSTR(CP.C1, 1, decode(INSTR(CP.C1, ',', 1, 3 ),0,LENGTH(CP.C1) ,INSTR(CP.C1, ',', 1, 3 )) - 1) PAR,
         TEMP.GOODS_NO GOODSNO FROM
		 (SELECT ORDER_NO,
                 ORDER_TYPE,
                 SPLIT_STATUS,
                 CUST_NO,
                 GOODS_NO,
                 GOODS_PRICE,
                 GOODS_DISCOUNT,
                 DEFAULT_PAY_DT,
                 WISH_PAY_DT,
                 ORDER_STATUS,
                 INSERT_DATE,
                 UPDATE_DATE,
                 SUPPLY_NO,
                 GOODS_COUNT,
                 ADDRESS,
                 STATUS,
                 goods_money,
                 UPDATE_CUST_TYPE,
                 TABLE_KEY,
                 ORDER_STATUS_SEL
            FROM T_BUS_ORDER TEMP
           WHERE STATUS = '1'
             AND SPLIT_STATUS in ('0','2')
           ) TEMP 
    LEFT JOIN DATA_CP CP
      ON TEMP.GOODS_NO = CP.CPDM
    LEFT JOIN DATA_CPMLS MLS
      ON CP.CODE = MLS.CODE
    LEFT JOIN T_USER_BASE_INFO U
      ON TEMP.CUST_NO = U.CUST_NO
     LEFT JOIN T_BUS_ADDRESS D
      ON TEMP.ORDER_NO = D.ORDER_NO
       left join T_USER_BASE_INFO SP
      ON TEMP.SUPPLY_NO = SP.CUST_NO
      where 1=1
      and temp.order_no=#orderNo#
	</select>
	
	<select id = "getByidDteail" parameterClass="java.lang.String" resultClass="com.hansy.transaction.model.bo.Order">
	select temp.order_status orderStatus,
       temp.order_no orderNo,
       temp.goods_price goodsPrice,
       temp.goods_count goodsCount,
       temp.goods_discount goodsDiscount,
       temp.insert_date insertDate,
       temp.order_type orderType,
       temp.TABLE_KEY tableKey,
       u.cust_name custName,
       u.user_phone custPhone,
       u.cust_no custNo,
       mls.name goodsName,
       mls.code goodsCode,
       to_char(temp.insert_date + temp.default_pay_dt, 'yyyy-mm-dd') defaultPayDt,
       to_char(temp.insert_date + temp.wish_pay_dt, 'yyyy-mm-dd') wishPayDt,
       d.telephone addresseePhone,
       d.addressee_name addresseeName,
       d.address address,
       temp.goods_no goodsNo
	from t_bus_order temp

  left join data_cp cp on temp.goods_no = cp.cpdm 
  left join data_cpmls mls on cp.code = mls.code
  left join t_user_base_info u
    on temp.cust_no = u.cust_no
   LEFT JOIN T_BUS_ADDRESS D
      ON TEMP.ORDER_NO = D.ORDER_NO
 where temp.ORDER_NO=#orderNo#
 
	</select>
	<!-- 查看粉丝下所购买的已经完成得订单,并且根据要求还要筛选排序什么的 -->
	<select id="getOrderByCustNo" parameterClass = "map" resultClass="com.hansy.transaction.model.bo.Order">
SELECT TEMP.ORDER_STATUS ORDERSTATUS,
         TEMP.ORDER_NO ORDERNO,
         TEMP.GOODS_PRICE GOODSPRICE,
         TEMP.GOODS_COUNT GOODSCOUNT,
         TEMP.GOODS_DISCOUNT GOODSDISCOUNT,
         TEMP.INSERT_DATE INSERTDATE,
         TEMP.ORDER_TYPE ORDERTYPE,
         TEMP.TABLE_KEY TABLEKEY,
         TEMP.SPLIT_STATUS splitStatus,
         U.CUST_NAME CUSTNAME,
         U.USER_PHONE CUSTPHONE,
         U.CUST_NO CUSTNO,
         MLS.NAME GOODSNAME,
         MLS.CODE GOODSCODE,
         TO_CHAR(TEMP.INSERT_DATE + TEMP.DEFAULT_PAY_DT, 'yyyy-mm-dd') DEFAULTPAYDT,
         TO_CHAR(TEMP.INSERT_DATE + TEMP.WISH_PAY_DT, 'yyyy-mm-dd') WISHPAYDT,
         D.TELEPHONE ADDRESSEEPHONE,
         D.ADDRESSEE_NAME ADDRESSEENAME,
         D.ADDRESS ADDRESS,
         TEMP.GOODS_NO GOODSNO
    FROM (SELECT ORDER_NO,
                 ORDER_TYPE,
                 SPLIT_STATUS,
                 CUST_NO,
                 GOODS_NO,
                 GOODS_PRICE,
                 GOODS_DISCOUNT,
                 DEFAULT_PAY_DT,
                 WISH_PAY_DT,
                 ORDER_STATUS,
                 INSERT_DATE,
                 UPDATE_DATE,
                 SUPPLY_NO,
                 GOODS_COUNT,
                 ADDRESS,
                 STATUS,
                 UPDATE_CUST_TYPE,
                 TABLE_KEY,
                 ORDER_STATUS_SEL
            FROM T_BUS_ORDER TEMP
           WHERE ORDER_STATUS_SEL = '1'
             AND SPLIT_STATUS in ('0','2')
) TEMP 
    LEFT JOIN DATA_CP CP
      ON TEMP.GOODS_NO = CP.CPDM
    LEFT JOIN DATA_CPMLS MLS
      ON CP.CODE = MLS.CODE
    LEFT JOIN T_USER_BASE_INFO U
      ON TEMP.CUST_NO = U.CUST_NO
   LEFT JOIN T_BUS_ADDRESS D
      ON TEMP.ORDER_NO = D.ORDER_NO
      where 1=1
          		<dynamic prepend="">  
		            <isNotEmpty property="orderStatus" prepend="and">  
		                <![CDATA[ 
		                    temp.order_status = #orderStatus# 
		                ]]> 
		            </isNotEmpty> 
		            <isNotEmpty property="startTime" prepend="and">  
		                <![CDATA[ 
		                    temp.INSERT_DATE >= to_date( #startTime#, 'yy-mm-dd')
		                ]]>  
		            </isNotEmpty>
		            <isNotEmpty property="endTime" prepend="and">  
		                <![CDATA[ 
		                   temp.INSERT_DATE >= to_date( #endTime#, 'yy-mm-dd')
		                ]]>  
		            </isNotEmpty>
		        </dynamic>	        
           			 order by temp.UPDATE_DATE desc
	</select>
	<select id = "getOrderByCustNoTotal" parameterClass = "map" resultClass="com.hansy.transaction.model.bo.Order">
	select count(distinct TEMP.ORDER_NO)from
		 (SELECT ORDER_NO,
                 ORDER_TYPE,
                 SPLIT_STATUS,
                 CUST_NO,
                 GOODS_NO,
                 GOODS_PRICE,
                 GOODS_DISCOUNT,
                 DEFAULT_PAY_DT,
                 WISH_PAY_DT,
                 ORDER_STATUS,
                 INSERT_DATE,
                 UPDATE_DATE,
                 SUPPLY_NO,
                 GOODS_COUNT,
                 ADDRESS,
                 STATUS,
                 UPDATE_CUST_TYPE,
                 TABLE_KEY,
                 ORDER_STATUS_SEL
            FROM T_BUS_ORDER TEMP
           WHERE ORDER_STATUS_SEL = '1'
             AND SPLIT_STATUS in ('0','2') ) TEMP 
    LEFT JOIN DATA_CP CP
      ON TEMP.GOODS_NO = CP.CPDM
    LEFT JOIN DATA_CPMLS MLS
      ON CP.CODE = MLS.CODE
    LEFT JOIN T_USER_BASE_INFO U
      ON TEMP.CUST_NO = U.CUST_NO
   LEFT JOIN T_BUS_ADDRESS D
      ON TEMP.ORDER_NO = D.ORDER_NO
      where 1=1
		            <isNotEmpty property="orderStatus" prepend="and">  
		                <![CDATA[ 
		                    temp.order_status = #orderStatus# 
		                ]]>  
		            </isNotEmpty>  
		             <isNotEmpty property="startTime" prepend="and">  
		                <![CDATA[ 
		                    temp.INSERT_DATE >= to_date( #startTime#, 'yy-mm-dd')
		                ]]>  
		            </isNotEmpty>
		            <isNotEmpty property="endTime" prepend="and">  
		                <![CDATA[ 
		                   temp.INSERT_DATE >= to_date( #endTime#, 'yy-mm-dd')
		                ]]>  
		            </isNotEmpty>
	</select>
	
	
	 <select id = "getUserSupplyDetail" parameterClass="java.lang.String" resultClass="com.hansy.transaction.model.vo.TUserSupplyInfoVo">
	SELECT T1.CUST_NO         AS CUSTNO,
       T1.CUST_NAME       AS CUSTNAME,
       T1.REG_NO          AS REGNO,
       T1.ORG_NO          AS ORGNO,
       T1.FAX_NO          AS FAXNO,
       T1.REG_TYPE        AS REGTYPE,
       T1.CERT_BEGIN_DT   AS CERTBEGINDT,
       T1.CERT_END_DT     AS CERTENDDT,
       T1.SCALE           AS SCALE,
       T1.LEGAL_PERSON    AS LEGALPERSON,
       T1.LEGAL_CERT_TYPE AS LEGALCERTTYPE,
       T1.LEGAL_CERT_NO   AS LEGALCERTNO,
       T1.BASE_ACCT_ORG   AS BASEACCTORG,
       T1.BASE_ACCT_NO    AS BASEACCTNO,
       T1.BASE_ACCT_NAME    AS BASEACCTNAME,
       T1.ANNUAL_INSP_DT  AS ANNUALINSPDT,
       T1.CHANGE_DT       AS CHANGEDT,
       T1.REG_CAPITAL     AS REGCAPITAL,
       T1.REG_ADDRESS     AS REGADDRESS,
       T1.REG_CURRENCY    AS REGCURRENCY,
       T1.PAID_IN_CAPITAL AS PAIDINCAPITAL,
       T1.PAID_CURRENCY   AS PAIDCURRENCY,
       T1.BIZ_ADDRESS     AS BIZADDRESS,
       T1.BRANCH_CNT      AS BRANCHCNT,
       T1.INSERT_DATE     AS INSERTDATE,
       T1.UPDATE_DATE     AS UPDATEDATE,
       T1.FILE_ID         AS FILEID,
       T1.STAFF_ID        AS STAFFID,
       T1.STAFF_NAME      AS STAFFNAME,
         t1.SUPPLY_NAME as supplyName,
    t1.SUPPLY_REMARK as supplyRemark,
    t1.SUPPLY_MOBILE as supplyMobile,
    t1.SUPPLY_SERVER_MOBILE as supplyServerMobile,
       T2.LIB_NAME        AS LIBNAME,
       T2.LIB_TITLE       AS LIBTITLE,
        substr(t2.LIB_DIRECTORY, instr(t2.LIB_DIRECTORY, 'files')) AS LIBDIRECTORY,
       T2.LIB_EXT_NAME    AS LIBEXTNAME,
       t2.LIB_ID as libId,
       T3.LIB_NAME        AS LIBNAME1,
       T3.LIB_TITLE       AS LIBTITLE1,
        substr(t3.LIB_DIRECTORY, instr(t3.LIB_DIRECTORY, 'files')) AS LIBDIRECTORY1,
       T3.LIB_EXT_NAME    AS LIBEXTNAME1,
       t3.LIB_ID as libId1
  FROM T_USER_SUPPLY_INFO T1
  LEFT  JOIN (SELECT * FROM SYS_LIBRARY WHERE LIB_TYPE = '003') T2
    ON T1.CUST_NO = T2.MENU_ID
  LEFT JOIN  (SELECT * FROM  SYS_LIBRARY WHERE LIB_TYPE = '001' ) T3
    ON T1.CUST_NO = T3.MENU_ID 
	              where    t1.CUST_NO = #custNo#
	</select> 
</sqlMap>
